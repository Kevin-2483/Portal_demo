# Portal Core åº«å®Œæ•´åˆ†æžå ±å‘Š

## æ¦‚è¦½
æœ¬å ±å‘Šåˆ†æžäº†Portal Coreåº«çš„å®Œæ•´æ€§ï¼Œè­˜åˆ¥äº†æ‰€æœ‰æœªå®Œæˆå¯¦ç¾ã€ç°¡åŒ–å¯¦ç¾å’Œéœ€è¦æ”¹é€²çš„éƒ¨åˆ†ã€‚

## ä¸€ã€å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½ âœ…

### 1. åŸºæœ¬å‚³é€é–€ç®¡ç†ç³»çµ±
- âœ… å‚³é€é–€å‰µå»ºã€éŠ·æ¯€å’ŒæŸ¥è©¢
- âœ… å‚³é€é–€éˆæŽ¥å’Œå–æ¶ˆéˆæŽ¥
- âœ… å¯¦é«”è¨»å†Šå’Œç®¡ç†
- âœ… A/Bé¢å°æ‡‰é—œä¿‚ä¿®å¾©

### 2. ä¸‰ç‹€æ…‹æ©Ÿç³»çµ±ï¼ˆæœ€æ–°å®Œæˆï¼‰
- âœ… NOT_TOUCHING â†’ CROSSING â†’ TELEPORTED ç‹€æ…‹ç®¡ç†
- âœ… åŸºæ–¼é‚Šç•Œæ¡†åˆ†æžçš„ç‹€æ…‹åˆ¤å®š
- âœ… å¹½éˆç¢°æ’žé«”ç®¡ç†ç³»çµ±
- âœ… é˜²æ­¢é »ç¹å‚³é€çš„ç©©å®šæ©Ÿåˆ¶

### 3. æ•¸å­¸è¨ˆç®—ç³»çµ±
- âœ… åº§æ¨™è®Šæ›çŸ©é™£è¨ˆç®—
- âœ… å‘é‡å’Œå››å…ƒæ•¸è®Šæ›
- âœ… å‚³é€é–€å¹³é¢æŠ•å½±
- âœ… é‚Šç•Œæ¡†åˆ†æžå’Œäº¤é›†æª¢æ¸¬
- âœ… ç‰©ç†ç‹€æ…‹è®Šæ›

### 4. æŽ¥å£æŠ½è±¡ç³»çµ±
- âœ… IPhysicsQuery / IPhysicsManipulator
- âœ… IRenderQuery / IRenderManipulator  
- âœ… IPortalEventHandler
- âœ… å¹½éˆç¢°æ’žé«”ç®¡ç†æŽ¥å£
- âœ… æ¸²æŸ“å‰ªè£å¹³é¢æ”¯æ´

## äºŒã€ç°¡åŒ–å¯¦ç¾éœ€è¦æ”¹é€² ðŸ”§

### 1. ç‰©ç†å°„ç·šæª¢æ¸¬ (`portal_example.h:68`)
```cpp
bool raycast(const Vector3& start, const Vector3& end, EntityId ignore_entity) const override {
    // ç°¡åŒ–çš„å°„ç·šæª¢æ¸¬ - å¯¦éš›å¯¦ç¾éœ€è¦èª¿ç”¨æ‚¨çš„ç‰©ç†å¼•æ“Ž
    return false;
}
```
**å½±éŸ¿**: å½±éŸ¿éžæ­¸æª¢æ¸¬å’Œç¢°æ’žæª¢æ¸¬ç²¾ç¢ºæ€§
**å„ªå…ˆç´š**: é«˜

### 2. è¦–éŒé«”è¨ˆç®— (`portal_example.h:162-171`)
```cpp
bool is_point_in_view_frustum(const Vector3& point, const CameraParams& camera) const override {
    // ç°¡åŒ–çš„è¦–éŒé«”æª¢æ¸¬
    Vector3 to_point = point - camera.position;
    float distance = to_point.length();
    return distance > camera.near_plane && distance < camera.far_plane;
}

Frustum calculate_frustum(const CameraParams& camera) const override {
    // ç°¡åŒ–çš„è¦–éŒé«”è¨ˆç®—
    Frustum frustum;
    // é€™è£¡éœ€è¦å¯¦éš›çš„è¦–éŒé«”è¨ˆç®—é‚è¼¯
    return frustum;
}
```
**å½±éŸ¿**: å½±éŸ¿æ¸²æŸ“å„ªåŒ–å’Œå¯è¦‹æ€§æª¢æ¸¬
**å„ªå…ˆç´š**: ä¸­

### 3. ç›¸å°é€Ÿåº¦è¨ˆç®—ç°¡åŒ– (`portal_math.cpp:193`)
```cpp
Vector3 calculate_relative_velocity(...) {
    // é€™è£¡ç°¡åŒ–è™•ç†ï¼Œåªè€ƒæ…®ç·šæ€§é€Ÿåº¦å·®ç•°
    Vector3 relative_velocity = entity_velocity - portal_velocity;
```
**å½±éŸ¿**: å‹•æ…‹å‚³é€é–€çš„ç‰©ç†ç²¾ç¢ºæ€§
**å„ªå…ˆç´š**: ä¸­

### 4. çŸ©é™£åˆ°å››å…ƒæ•¸è½‰æ› (`portal_math.cpp:326`)
```cpp
// é€™è£¡ç°¡åŒ–è™•ç†ï¼Œå¯¦éš›å¯¦ç¾éœ€è¦æ›´ç²¾ç¢ºçš„çŸ©é™£åˆ°å››å…ƒæ•¸è½‰æ›
```
**å½±éŸ¿**: æ—‹è½‰è®Šæ›ç²¾ç¢ºæ€§
**å„ªå…ˆç´š**: ä¸­

### 5. éžæ­¸æª¢æ¸¬ç®—æ³• (`portal_math.cpp:343`)
```cpp
// ç°¡åŒ–æª¢æ¸¬ï¼šå¦‚æžœç›¸æ©Ÿèƒ½å¤ é€šéŽportal1çœ‹åˆ°portal2ï¼Œä¸¦ä¸”portal2èƒ½å¤ çœ‹åˆ°portal1ï¼Œå‰‡ç‚ºéžæ­¸
```
**å½±éŸ¿**: éžæ­¸æ¸²æŸ“æª¢æ¸¬çš„æº–ç¢ºæ€§
**å„ªå…ˆç´š**: ä½Ž

## ä¸‰ã€å®Œå…¨ç¼ºå¤±çš„åŠŸèƒ½ âŒ

### 1. å®Œæ•´çš„æ¸²æŸ“ç®¡ç·š
- ç¼ºå°‘å¯¦éš›çš„Stencil Bufferç®¡ç†
- ç¼ºå°‘æ·±åº¦æ¸¬è©¦é…ç½®
- ç¼ºå°‘å¤šå±¤éžæ­¸æ¸²æŸ“å¯¦ç¾

### 2. å®Œæ•´çš„ç‰©ç†æ•´åˆ
- ç¼ºå°‘èˆ‡å…·é«”ç‰©ç†å¼•æ“Žçš„æ•´åˆä»£ç¢¼
- ç¼ºå°‘ç¢°æ’žå½¢ç‹€è®Šæ›é‚è¼¯
- ç¼ºå°‘ç‰©ç†ç´„æŸè™•ç†

### 3. æ€§èƒ½å„ªåŒ–ç³»çµ±
- ç¼ºå°‘ç©ºé–“åˆ†å‰²æ•¸æ“šçµæ§‹
- ç¼ºå°‘LODç³»çµ±
- ç¼ºå°‘æ‰¹é‡è™•ç†å„ªåŒ–

## å››ã€å»ºè­°çš„æ”¹é€²å„ªå…ˆç´š

### é«˜å„ªå…ˆç´š ðŸ”´
1. **å¯¦ç¾çœŸå¯¦çš„å°„ç·šæª¢æ¸¬**
   ```cpp
   // åœ¨ ExamplePhysicsQuery ä¸­å¯¦ç¾ï¼š
   bool raycast(const Vector3& start, const Vector3& end, EntityId ignore_entity) const override {
       // æ•´åˆå¯¦éš›ç‰©ç†å¼•æ“Žçš„å°„ç·šæª¢æ¸¬
       // ä¾‹å¦‚ï¼šBullet Physics, PhysX, æˆ–è‡ªå®šç¾©å¯¦ç¾
   }
   ```

2. **å®Œå–„é‚Šç•Œæ¡†åˆ†æžç²¾ç¢ºåº¦**
   ```cpp
   // åœ¨ PortalMath::analyze_entity_bounding_box ä¸­å¢žåŠ ï¼š
   // - æ—‹è½‰é‚Šç•Œæ¡†æ”¯æ´
   // - è¤‡é›œå½¢ç‹€è¿‘ä¼¼
   // - å‹•æ…‹é‚Šç•Œæ¡†æ›´æ–°
   ```

### ä¸­å„ªå…ˆç´š ðŸŸ¡
1. **å®Œå–„è¦–éŒé«”è¨ˆç®—**
2. **æ”¹é€²ç›¸å°é€Ÿåº¦è¨ˆç®—**
3. **å¢žå¼·çŸ©é™£è½‰æ›ç²¾ç¢ºåº¦**

### ä½Žå„ªå…ˆç´š ðŸŸ¢
1. **å„ªåŒ–éžæ­¸æª¢æ¸¬ç®—æ³•**
2. **æ·»åŠ æ€§èƒ½ç›£æŽ§å·¥å…·**
3. **å¯¦ç¾èª¿è©¦å¯è¦–åŒ–**

## äº”ã€æ¸¬è©¦è¦†è“‹ç¾ç‹€

### å·²æ¸¬è©¦åŠŸèƒ½
- âœ… åŸºæœ¬å‚³é€é–€å‰µå»ºå’ŒéˆæŽ¥
- âœ… å¯¦é«”è¨»å†Šå’Œå‚³é€
- âœ… ä¸‰ç‹€æ…‹æ©Ÿè½‰æ›
- âœ… åº§æ¨™è®Šæ›è¨ˆç®—

### æœªæ¸¬è©¦åŠŸèƒ½
- âŒ å¹½éˆç¢°æ’žé«”å¯¦éš›ç‰©ç†äº’å‹•
- âŒ è¤‡é›œå ´æ™¯éžæ­¸æ¸²æŸ“
- âŒ é‚Šç·£æƒ…æ³ç•°å¸¸è™•ç†
- âŒ æ€§èƒ½å£“åŠ›æ¸¬è©¦

## å…­ã€å¯¦ç¾å»ºè­°

### 1. çŸ­æœŸæ”¹é€² (1-2é€±)
```cpp
// å¯¦ç¾åŸºæœ¬å°„ç·šæª¢æ¸¬
class ImprovedPhysicsQuery : public ExamplePhysicsQuery {
public:
    bool raycast(const Vector3& start, const Vector3& end, EntityId ignore_entity) const override {
        // ä½¿ç”¨ç°¡å–®çš„AABBæª¢æ¸¬ä½œç‚ºç¬¬ä¸€æ­¥æ”¹é€²
        for (const auto& [id, entity] : entities_) {
            if (id == ignore_entity) continue;
            
            Vector3 min_bounds = entity.transform.position + entity.bounds_min;
            Vector3 max_bounds = entity.transform.position + entity.bounds_max;
            
            if (ray_intersects_aabb(start, end, min_bounds, max_bounds)) {
                return true;
            }
        }
        return false;
    }
};
```

### 2. ä¸­æœŸæ”¹é€² (1å€‹æœˆ)
- æ•´åˆå¯¦éš›ç‰©ç†å¼•æ“Ž
- å¯¦ç¾å®Œæ•´çš„è¦–éŒé«”è¨ˆç®—
- æ·»åŠ æ€§èƒ½ç›£æŽ§

### 3. é•·æœŸæ”¹é€² (3å€‹æœˆ)
- å®Œæ•´çš„æ¸²æŸ“ç®¡ç·šå¯¦ç¾
- å…ˆé€²çš„ç©ºé–“åˆ†å‰²ç®—æ³•
- å®Œå–„çš„éŒ¯èª¤è™•ç†å’Œæ¢å¾©æ©Ÿåˆ¶

## ä¸ƒã€çµè«–

Portal Coreåº«çš„**æ ¸å¿ƒæž¶æ§‹æ˜¯å¥å…¨çš„**ï¼Œä¸‰ç‹€æ…‹æ©Ÿç³»çµ±æ˜¯ä¸€å€‹é‡å¤§çš„æ”¹é€²ï¼Œç‚ºç©©å®šçš„å‚³é€é–€éæ­·æä¾›äº†åŸºç¤Žã€‚ä¸»è¦çš„é™åˆ¶åœ¨æ–¼ä¸€äº›**ç°¡åŒ–çš„å¯¦ç¾**å’Œ**ç¼ºå¤±çš„æ•´åˆä»£ç¢¼**ï¼Œé€™äº›éƒ½æ˜¯å¯ä»¥é€æ­¥æ”¹é€²çš„ã€‚

**ç•¶å‰ç‹€æ…‹**: ðŸŸ¢ **å¯ç”¨æ–¼åŽŸåž‹å’Œæ¦‚å¿µé©—è­‰**
**ç”Ÿç”¢å°±ç·’**: ðŸŸ¡ **éœ€è¦ä¸­å„ªå…ˆç´šæ”¹é€²å¾Œå¯ç”¨æ–¼ç”Ÿç”¢**

ä¸‹ä¸€æ­¥å»ºè­°å°ˆæ³¨æ–¼å¯¦ç¾çœŸå¯¦çš„å°„ç·šæª¢æ¸¬å’Œè¦–éŒé«”è¨ˆç®—ï¼Œé€™å°‡é¡¯è‘—æé«˜ç³»çµ±çš„å¯¦ç”¨æ€§ã€‚
